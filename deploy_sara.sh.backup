#!/bin/bash

# Alternative SARA API Deployment Methods
# When organization policies restrict permissions

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PROJECT_ID="precise-equator-274319"
REGION="us-east1"

echo -e "${BLUE}Alternative SARA API Deployment Methods${NC}"
echo "================================================"

echo -e "${YELLOW}Your organization has strict policies. Here are your options:${NC}"
echo ""

# Option 1: Contact Organization Admin
echo -e "${BLUE}Option 1: Contact Organization Administrator${NC}"
echo "-------------------------------------------"
echo "Contact your Google Cloud organization admin to:"
echo "• Enable required APIs (cloudbuild, run, secretmanager, artifactregistry)"
echo "• Grant you specific IAM roles:"
echo "  - Cloud Build Editor"
echo "  - Cloud Run Admin" 
echo "  - Secret Manager Admin"
echo "  - Artifact Registry Admin"
echo "  - Service Account User"
echo ""

# Option 2: Use existing enabled services
echo -e "${BLUE}Option 2: Check What's Already Available${NC}"
echo "----------------------------------------"
echo "Let's see what APIs are already enabled and what permissions you have:"

echo ""
echo "Checking enabled APIs..."
gcloud services list --enabled --format="table(name)" 2>/dev/null || echo "Cannot list APIs"

echo ""
echo "Checking your current roles..."
gcloud projects get-iam-policy $PROJECT_ID --flatten="bindings[].members" \
    --format='table(bindings.role)' \
    --filter="bindings.members:$(gcloud auth list --filter=status:ACTIVE --format='value(account)')" \
    2>/dev/null || echo "Cannot check IAM policies"

echo ""
echo -e "${BLUE}Option 3: Manual Deployment Steps${NC}"
echo "--------------------------------"
echo "If some APIs are enabled, you can try manual steps:"

echo ""
echo "1. Check if Artifact Registry repo exists:"
echo "   gcloud artifacts repositories list --location=$REGION"

echo ""
echo "2. If Cloud Build is available, try building manually:"
echo "   cd sara-api"
echo "   gcloud builds submit --tag $REGION-docker.pkg.dev/$PROJECT_ID/sara/sara-api:latest ."

echo ""
echo "3. If Cloud Run is available, deploy manually:"
echo "   gcloud run deploy sara-api --image=[IMAGE_URL] --region=$REGION"

echo ""
echo -e "${BLUE}Option 4: Create New Project${NC}"
echo "----------------------------"
echo "Create a new personal project without organization policies:"
echo "1. Go to https://console.cloud.google.com/"
echo "2. Click 'New Project'"
echo "3. Create project outside your organization"
echo "4. Use that project for development/testing"

echo ""
echo -e "${BLUE}Option 5: Local Development${NC}"
echo "----------------------------"
echo "Run SARA API locally for development:"
echo "cd sara-api"
echo "pip install -r requirements.txt"
echo "python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000"

echo ""
echo -e "${BLUE}Option 6: Service Account Approach${NC}"
echo "--------------------------------"
echo "If you have a service account with proper permissions:"
echo "1. Download service account key"
echo "2. Set GOOGLE_APPLICATION_CREDENTIALS environment variable"
echo "3. Run deployment with service account credentials"

echo ""
echo -e "${YELLOW}Recommended immediate actions:${NC}"
echo "1. Check what APIs are already enabled (see output above)"
echo "2. Contact your organization admin for required permissions"
echo "3. Try creating a new personal project for testing"

echo ""
echo -e "${GREEN}Current project status check completed!${NC}"